# Feature Specification: 計画の日程表示・自動リスケジュール

**Feature Branch**: `002-plan-schedule-reschedule`  
**Created**: 2025-01-25  
**Status**: Draft  
**Input**: User description: "次の使用を追加したいです。（docs/prd-mvp-add.md に基づく）"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 日程ビューで計画を確認する (Priority: P1)

ユーザーは、学習計画を「いつ・何をやるか」が分かる日付ベースのビューで確認できる。今日から一定期間（MVP では 14 日分）の日付ごとに、紐づくタスク一覧とステータス（予定・実施済み・未達・スキップ）が表示される。

**Why this priority**: 計画の可視化がなければ、自動リスケジュールの効果も伝わらない。まず「見える化」が前提。

**Independent Test**: 計画画面を開き、今日から 14 日分の日付が表示され、各日にタスクが紐づいていること、およびタスクごとにステータスが分かることを確認する。これだけで「いつ何をやるか」が把握できる。

**Acceptance Scenarios**:

1. **Given** ユーザーが学習目標とステップを持つ, **When** 計画画面を開く, **Then** 今日から 14 日分の日付が縦リストで表示され、各日付に紐づくタスク一覧とステータスが表示される
2. **Given** 計画画面を表示中, **When** タスクに実施済み・未達・スキップのいずれかが付与されている, **Then** 各タスクのステータスが区別して表示される（予定 / 実施済み / 未達 / スキップ）
3. **Given** ある日にタスクが存在しない, **When** 計画画面を表示する, **Then** その日は空であるか、タスクなしであることが分かる

---

### User Story 2 - 未達・スキップ時に自動で繰り越される (Priority: P2)

予定日にタスクが実施されず「未達」になった場合、またはユーザーが「今日はできない（スキップ）」を選んだ場合、システムが当該タスクを次の空き日に自動で繰り越す。1 日あたりのタスク数（または所要時間）上限を超えないよう制御する。

**Why this priority**: 計画倒れを防ぎ、学習継続率を上げる中核機能。日程表示の次に必要。

**Independent Test**: 未達タスクを 1 件作り、自動処理の実行後、そのタスクが「今日以降の空いている日」に移動していること、および 1 日の上限を超えて配置されていないことを確認する。

**Acceptance Scenarios**:

1. **Given** 予定日を過ぎてもステータスが「予定」のままのタスクが存在する, **When** 自動リスケジュールが発火する（翌日を迎えた、またはユーザーがスキップ選択）, **Then** 当該タスクは今日以降の「空いている日」のいずれかに再配置される
2. **Given** ユーザーがタスクに対して「今日はできない（スキップ）」を選択した, **When** 自動リスケジュールが実行される, **Then** 当該タスクは次の空き日に繰り越される
3. **Given** 1 日あたりのタスク数（または所要時間）上限が設定されている, **When** 自動リスケジュールでタスクを配置する, **Then** いずれの日も上限を超えない
4. **Given** 繰り越し対象タスクが複数ある, **When** 自動リスケジュールを実行する, **Then** 優先順位（期限が近い > 弱点復習 > 通常）に従って配置される

---

### User Story 3 - 期限・期間超過時にアラートが表示される (Priority: P3)

資格モードで期限を、Skill モードで学習期間（開始日＋期間）を超えてタスクを配置できそうな場合、ユーザーにアラートが表示される。MVP では警告表示のみで、超過を完全に防ぐブロックは必須としない。

**Why this priority**: 計画の破綻を事前に知らせ、対応を促す。自動繰り越しより優先度は下がるが、体験向上に寄与する。

**Independent Test**: 期限（または学習期間）を過ぎそうな状態で自動リスケジュールを行い、アラートが表示されることを確認する。

**Acceptance Scenarios**:

1. **Given** 資格モードで期限が設定されている, **When** 自動リスケジュールの結果、期限を超える日にタスクが配置されそうになる, **Then** ユーザーにアラートが表示される
2. **Given** Skill モードで学習期間（開始日＋期間）が設定されている, **When** 自動リスケジュールの結果、期間を超える日にタスクが配置されそうになる, **Then** ユーザーにアラートが表示される

---

### Edge Cases

- 今日以降 14 日間すべてが上限に達している場合、繰り越しタスクをどこに配置するか（次週へ伸ばす、アラートのみ等）をどう扱うか
- 同一日に「未達」と「スキップ」が混在する場合の優先順位と表示
- 自動リスケジュール実行中にユーザーが別画面でタスクを編集した場合の一貫性
- タイムゾーンや「日」の切り替え時刻（0 時 vs ユーザー設定）の扱い

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、タスクに「予定日」（日付）を紐づけて保存できるようにする
- **FR-002**: システムは、タスクごとにステータス（予定・実施済み・未達・スキップ）を保存し、表示する
- **FR-003**: ユーザーは、計画画面において「今日から 14 日分」の日付を日次単位で確認できる
- **FR-004**: 計画画面では、各日付に紐づくタスク一覧と、各タスクのステータスが表示される
- **FR-005**: 予定日を過ぎてもステータスが「予定」のままのタスク、またはユーザーが「スキップ」したタスクについて、システムは自動で「今日以降の空いている日」へ繰り越す
- **FR-006**: 自動リスケジュール時、1 日あたりのタスク数または所要時間の上限を超えないように配置する
- **FR-007**: 繰り越し配置の優先順位は、期限が近いタスク > 弱点復習タスク > 通常タスクとする
- **FR-008**: 資格モードで期限を、Skill モードで学習期間を超えてタスクが配置されそうになる場合、ユーザーにアラートを表示する
- **FR-009**: ユーザーは、タスクに対して「今日はできない（スキップ）」を選択できる（MVP では任意実装可）
- **FR-010**: ホーム（今日）画面で、今日のタスクと計画遅延の有無（例：未達件数）を確認できる

### Key Entities

- **Task（タスク）**: 学習ステップや復習・クイズ等の単位。予定日・ステータス・任意で所要時間を持つ。既存の Step を拡張するか、別エンティティとするかは実装時に決定
- **Schedule View（計画ビュー）**: 日付を軸にした表示。MVP では今日から 14 日分の日次リスト
- **Reschedule Event（リスケジュール履歴）**: 繰り越しの履歴（元日付・移動先日付・対象タスク・理由）。MVP では任意

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: タスクに予定日が保存され、計画画面で日付ごとにタスクが表示される
- **SC-002**: 未達タスクが自動で翌日以降の空き日に繰り越される
- **SC-003**: 1 日あたりのタスク（または所要時間）上限を超えて配置されない
- **SC-004**: 期限または学習期間を超えそうな場合にアラートが表示される
- **SC-005**: ユーザーが「いつ・何をやるか」を計画画面だけで把握できる

## Dependencies & Assumptions

- **Dependencies**: 既存の学習目標・ステップ（Skill Goal / Step）が存在すること。本機能はそれらに「予定日」「ステータス」を付与し、計画ビューと自動リスケジュールを提供する
- **Assumptions**: 
  - MVP の計画表示は「今日から 14 日分の縦リスト」とする（カレンダー UI は対象外）
  - 1 日あたりの上限は、タスク数または所要時間のいずれかで制御する（具体値は実装時決定）
  - 資格モード・Skill モードの区別と、期限・学習期間の扱いは既存仕様または別定義に従う
