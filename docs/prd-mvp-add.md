# 追加仕様：計画の日程表示・自動リスケジュール

## 1. 目的

- 学習計画を「日付ベース」で可視化し、ユーザーが **いつ・何をやるか** を直感的に把握できるようにする  
- 未達や予定変更が発生しても、計画が破綻しないよう **自動で立て直す仕組み** を提供する  
- 計画倒れを防ぎ、学習の継続率・目標達成率を向上させる  

---

## 2. 追加機能概要（MVP）

### 2.1 計画の日程表示（Schedule View）

- **表示単位**
  - 日次表示（必須）
  - 週次表示（将来拡張）
- **日次表示内容**
  - 日付
  - 紐づくタスク一覧（Step / 復習 / クイズなど）
  - ステータス  
    - `scheduled`（予定）  
    - `done`（実施済み）  
    - `missed`（未達）  
    - `skipped`（スキップ）
- **UI（MVP）**
  - 画面パス：`/plan` または `/skill/{goalId}/plan`
  - カレンダーUIは使わず、**今日から14日分の縦リスト表示**で実装

---

### 2.2 自動リスケジュール（Auto Reschedule）

#### 発火条件

- 予定日にタスクが `scheduled` のまま翌日を迎えた場合  
- ユーザーが「今日はできない（Skip）」を選択した場合  

#### 基本ルール（MVP）

- 未達タスクは **次の空いている日** に自動的に繰り越す  
- 1日の負荷上限を超えないよう制御する  
  - 例：1日あたり最大2タスク、または60分以内  
- 期限（資格モード）や学習期間（Skillモード）を超えそうな場合はアラート表示  

#### 優先順位

1. 期限が近いタスク  
2. 弱点復習タスク  
3. 通常タスク  

---

## 3. データ要件（Firestore想定）

### 3.1 既存タスクへの追加フィールド

- `scheduledDate: string`（YYYY-MM-DD）
- `status: "scheduled" | "done" | "missed" | "skipped"`
- `estimatedMinutes?: number`（任意）

### 3.2 リスケジュール履歴（任意）

- コレクション：`rescheduleEvents`
  - `goalId`
  - `fromDate`
  - `toDate`
  - `movedTaskIds`
  - `reason: "missed" | "skipped" | "manual"`

---

## 4. 自動リスケジュール ロジック（MVP）

### 4.1 対象判定

- `scheduledDate < today`
- `status === "scheduled"`

### 4.2 移動先探索

- `today` 以降の日付を順に確認
- その日のタスク数（または分数）が上限未満なら配置
- 上限超過時は翌日へ繰り越し

### 4.3 期限・期間の扱い

- **資格モード**
  - `deadline` を超える日付には配置しない
- **Skillモード**
  - `startDate + duration` を超える日付には配置しない
- 超過が見込まれる場合は警告表示のみ（MVP）

---

## 5. UI追加・導線

### 新規画面

- `/plan`
  - 今日〜2週間分の予定を日付順に表示

### 既存画面の拡張

- Home（今日）
  - 今日のタスク
  - 計画遅延バッジ（例：「未達2件」）
- Step詳細
  - `scheduledDate` 表示
  - `Skip` ボタン（任意）

---

## 6. 受け入れ基準（Done条件）

- タスクに `scheduledDate` が保存されている  
- `/plan` 画面で日付ごとにタスクが表示される  
- 未達タスクが翌日に自動繰り越しされる  
- 1日のタスク上限を超えない  
- 期限・期間超過時にアラートが表示される  

---

## 7. 今後の拡張（v0.2以降）

- 曜日別の可処分時間を考慮した再スケジューリング  
- 間隔反復（1日後 / 3日後 / 7日後）による復習配置  
- AIによる「挽回モード（圧縮プラン）」提案  
- Googleカレンダー連携（予定に応じた負荷調整）
